<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>ShopHub - Premium Online Store</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <style>
    /* üé® DYNAMIC THEME VARIABLES */
    :root {
      /* Default Theme (Matches your 'default' key) */
      --color-primary: #001f3f; 
      --color-secondary: #004d40;
      
      --color-bg-light: #F9FAFB;
      --color-text-main: #111827;
      
      /* Smooth Theme Transition */
      --transition-speed: 0.5s;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--color-bg-light);
      color: var(--color-text-main);
      /* This ensures the whole page theme morphs smoothly */
      transition: background-color var(--transition-speed), color var(--transition-speed);
    }

    /* üåà Utility Classes using CSS Variables */
    .theme-text-primary { color: var(--color-primary); transition: color var(--transition-speed); }
    .theme-bg-primary { background-color: var(--color-primary); transition: background-color var(--transition-speed); }
    .theme-border-primary { border-color: var(--color-primary); transition: border-color var(--transition-speed); }
    
    /* Hover Effects */
    .theme-hover-bg-primary:hover { background-color: var(--color-primary); }
    .theme-hover-text-primary:hover { color: var(--color-primary); }

    /* Button Styling with Variables */
    .btn-primary {
        background-color: var(--color-primary);
        color: white;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1), background-color var(--transition-speed);
    }
    .btn-primary:hover {
        filter: brightness(1.15); 
        transform: translateY(-1px);
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        background-color: var(--color-secondary);
    }

    /* ‚ö° Standard Transitions */
    a, .card, input, .transition-enabled, .group {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    /* ‚öôÔ∏è Sidebar & Layout Styles */
    .sidebar-wrapper {
      position: fixed; left: 0; top: 0; height: 100%; width: 20rem; 
      background-color: white; z-index: 50;
      transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      display: flex; flex-direction: column; border-right: 1px solid #F3F4F6;
    }
    .sidebar-open .sidebar-wrapper { transform: translateX(0); box-shadow: 20px 0 50px rgba(0,0,0,0.1); }
    
    .backdrop {
      position: fixed; inset: 0; background-color: rgba(0,0,0,0.4); z-index: 40;
      backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px);
      opacity: 0; transition: opacity 0.4s ease; pointer-events: none;
    }
    .sidebar-open .backdrop { opacity: 1; pointer-events: auto; }

    /* Utilities */
    .scrollbar-hide::-webkit-scrollbar { display: none; }
    .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    .z-50-click { z-index: 50; position: relative; pointer-events: auto !important; }
    
    /* üéûÔ∏è Animations */
    .page-enter { animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; opacity: 0; }
    @keyframes fadeUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }

    /* Staggered grid animation */
    .grid-stagger > * { opacity: 0; animation: fadeUp 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    .grid-stagger > *:nth-child(1) { animation-delay: 0.1s; }
    .grid-stagger > *:nth-child(2) { animation-delay: 0.15s; }
    .grid-stagger > *:nth-child(3) { animation-delay: 0.2s; }
    .grid-stagger > *:nth-child(4) { animation-delay: 0.25s; }

    /* ‚ú® Toast Notifications */
    #toast-container {
        position: fixed; bottom: 24px; right: 24px; z-index: 100;
        display: flex; flex-direction: column; gap: 12px; pointer-events: none;
    }
    .toast {
        background: white; padding: 16px 20px; border-radius: 12px;
        box-shadow: 0 20px 40px -10px rgba(0,0,0,0.15), 0 0 1px rgba(0,0,0,0.1);
        display: flex; items-center; gap: 12px;
        transform: translateY(100%) scale(0.9); opacity: 0; 
        transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        pointer-events: auto; border-left: 4px solid var(--color-primary); min-width: 300px;
    }
    .toast.show { transform: translateY(0) scale(1); opacity: 1; }
    .toast-success { border-color: #10B981; }
    .toast-error { border-color: #EF4444; }

    /* Enhanced Card Shadows */
    .premium-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
    .premium-shadow:hover { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 10px 10px -5px rgba(0, 0, 0, 0.02); }

  </style>
</head>
<body class="antialiased selection:bg-gray-200 selection:text-gray-900">

  <div id="app"></div>

  <div id="toast-container"></div>

  <script>
    // ---------------------------------------------------------
    // ‚öôÔ∏è CONFIGURATION & STATE
    // ---------------------------------------------------------
    // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL SUPABASE CREDENTIALS
    const SUPABASE_URL = 'https://thzmryhnyzhfewsyamjh.supabase.co'; 
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoem1yeWhueXpoZmV3c3lhbWpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTgwMTAsImV4cCI6MjA4MDMzNDAxMH0.qvCid4pmsdcRogce4RZH5adl90Eq5d3ibwVoJI5qr-I';
    const ADMIN_EMAIL = 'utkwholesale.sup@gmail.com'; 

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const state = {
      user: null,
      isAdmin: false,
      products: [],
      categories: [],
      cart: [],
      currentPage: 'home',
      currentSlug: null,
      isSidebarOpen: false,
      authMode: 'login',
      editingProduct: null
    };

    // üé® YOUR CUSTOM CATEGORY THEMES
    const CATEGORY_THEMES = {
      'candies-chocolates': { primary: '#ec4899', secondary: '#be185d', icon: 'üç¨' },
      'tobacco-products':   { primary: '#78350f', secondary: '#451a03', icon: 'üö¨' },
      'automotive':         { primary: '#dc2626', secondary: '#991b1b', icon: 'üöó' },
      'medicines':          { primary: '#059669', secondary: '#065f46', icon: 'üíä' },
      'toys':               { primary: '#f59e0b', secondary: '#b45309', icon: 'üß∏' },
      'household':          { primary: '#4f46e5', secondary: '#312e81', icon: 'üè†' },
      'general-grocery':    { primary: '#0891b2', secondary: '#164e63', icon: 'ü•¶' },
      'snacks':             { primary: '#d97706', secondary: '#92400e', icon: 'üçø' },
      'default':            { primary: '#001f3f', secondary: '#004d40', icon: '‚ú®' }
    };

    // Helper to match category string to theme key (handles spaces/caps)
    function getThemeForCategory(categoryName) {
        if (!categoryName) return CATEGORY_THEMES['default'];
        const key = categoryName.toLowerCase().trim().replace(/\s+/g, '-'); // "General Grocery" -> "general-grocery"
        return CATEGORY_THEMES[key] || CATEGORY_THEMES['default'];
    }

    function applyTheme(categoryName) {
        const theme = getThemeForCategory(categoryName);
        const root = document.documentElement;
        
        // Apply CSS Variables
        root.style.setProperty('--color-primary', theme.primary);
        root.style.setProperty('--color-secondary', theme.secondary);
        // We use primary with low opacity for backgrounds in CSS
    }

    // ---------------------------------------------------------
    // üé® ICONS (SVG Helpers)
    // ---------------------------------------------------------
    const Icon = {
      Menu: () => `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>`,
      Cart: () => `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path></svg>`,
      ChevronLeft: () => `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>`,
      Plus: () => `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>`,
      Trash: () => `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`,
      Edit: () => `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`,
      CheckBadge: () => `<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>`,
      XCircle: () => `<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>`,
      Close: () => `<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>`
    };

    // ---------------------------------------------------------
    // üõ†Ô∏è CORE FUNCTIONS
    // ---------------------------------------------------------

    function navigate(page, slug = null) {
      state.currentPage = page;
      state.currentSlug = slug;
      state.isSidebarOpen = false;
      state.editingProduct = null;
      
      // üé® Theme Logic: Change theme based on context
      if (page === 'product' && slug) {
          const product = state.products.find(p => p.slug === slug);
          if (product && product.category) applyTheme(product.category);
      } else {
          applyTheme('default');
      }

      render();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function toggleSidebar() {
      state.isSidebarOpen = !state.isSidebarOpen;
      render();
    }

    function setAuthMode(mode) {
        state.authMode = mode;
        render();
    }

    // ‚ú® Toast Notification System
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type === 'success' ? 'toast-success' : 'toast-error'}`;
        toast.innerHTML = `
            <div class="flex-shrink-0">${type === 'success' ? Icon.CheckBadge() : Icon.XCircle()}</div>
            <p class="font-medium text-gray-900">${message}</p>
        `;
        container.appendChild(toast);
        requestAnimationFrame(() => toast.classList.add('show'));
        setTimeout(() => {
            toast.classList.remove('show');
            setTimeout(() => toast.remove(), 400);
        }, 3000);
    }

    // ---------------------------------------------------------
    // üõçÔ∏è CART LOGIC
    // ---------------------------------------------------------
    async function addToCart(product, e) {
        if (e) { e.stopPropagation(); e.preventDefault(); }
        
        if (!state.user) {
            showToast("Please login to add items to cart", "error");
            navigate('auth');
            return;
        }

        showToast(`Adding <b>${product.name}</b> to cart...`, 'success');
        
        const existing = state.cart.find(item => item.product_id === product.id);
        let error;

        if (existing) {
            const { error: updateError } = await supabase.from('cart_items')
                .update({ quantity: existing.quantity + 1 })
                .eq('id', existing.id);
            error = updateError;
        } else {
            const { error: insertError } = await supabase.from('cart_items').insert({
                user_id: state.user.id,
                product_id: product.id,
                quantity: 1
            });
            error = insertError;
        }
        
        if (!error) await fetchCart();
        else {
            showToast("Failed to add to cart.", "error");
            console.error("Cart Error:", error);
        }
    }

    async function fetchCart() {
        if (!state.user) { state.cart = []; render(); return; }
        const { data, error } = await supabase.from('cart_items')
            .select('*, product:products(*)')
            .eq('user_id', state.user.id)
            .order('created_at');
        if (data) state.cart = data;
        render(); 
    }

    // ---------------------------------------------------------
    // üîê AUTH LOGIC
    // ---------------------------------------------------------
    async function handleAuth(e) {
        e.preventDefault();
        const email = e.target.email.value;
        const password = e.target.password.value;
        let error;

        if (state.authMode === 'signup') {
            const { error: signUpError } = await supabase.auth.signUp({ email, password });
            error = signUpError;
            if (!error) showToast("Signup successful! Check email.");
        } else {
            const { error: signInError } = await supabase.auth.signInWithPassword({ email, password });
            error = signInError;
            if (!error) {
                showToast("Successfully logged in!", "success");
                navigate('home');
            }
        }
        if (error) showToast(error.message, "error");
    }

    async function handleLogout() {
        await supabase.auth.signOut();
        showToast("Logged out successfully.");
        navigate('home');
    }

    // ---------------------------------------------------------
    // üëÆ ADMIN FUNCTIONS
    // ---------------------------------------------------------
    async function handleAddProduct(e) {
        e.preventDefault();
        if (!state.isAdmin) return;
        
        const form = e.target;
        // Basic slug generation
        const slugStr = form.name.value.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
        const newProduct = {
            name: form.name.value,
            price: parseFloat(form.price.value),
            image_url: form.image_url.value,
            description: form.description.value,
            category: form.category.value.toLowerCase(), // Store lowercase to match keys
            slug: `${slugStr}-${Math.floor(Math.random() * 10000)}`,
        };

        const { error } = await supabase.from('products').insert([newProduct]);
        if (error) showToast(error.message, 'error');
        else {
            showToast('Product added!', 'success');
            closeModal('add-product-modal');
            await fetchProducts();
        }
    }

    async function handleUpdateProduct(e) {
        e.preventDefault();
        if (!state.isAdmin || !state.editingProduct) return;
        const form = e.target;
        const updates = {
            name: form.name.value,
            price: parseFloat(form.price.value),
            image_url: form.image_url.value,
            description: form.description.value,
            category: form.category.value.toLowerCase()
        };
        const { error } = await supabase.from('products').update(updates).eq('id', state.editingProduct.id);
        if (error) showToast(error.message, 'error');
        else {
            showToast('Updated!', 'success');
            closeModal('edit-product-modal');
            state.editingProduct = null;
            await fetchProducts();
        }
    }

    async function handleDeleteProduct(id) {
        if (!confirm('Delete this product?')) return;
        const { error } = await supabase.from('products').delete().eq('id', id);
        if (error) showToast(error.message, 'error');
        else {
            showToast('Deleted.', 'success');
            await fetchProducts();
        }
    }

    async function fetchProducts() {
         const { data, error } = await supabase.from('products').select('*').order('created_at', { ascending: false });
         if (data) {
             state.products = data;
             // Extract categories but prioritize keys we know
             state.categories = [...new Set(data.map(p => p.category || 'uncategorized'))];
         }
         render();
    }

    function openEditModal(productId) {
        const product = state.products.find(p => p.id === productId);
        if (!product) return;
        state.editingProduct = product;
        render(); 
        setTimeout(() => document.getElementById('edit-product-modal').showModal(), 50);
    }

    function closeModal(modalId) {
        document.getElementById(modalId).close();
        if (modalId === 'edit-product-modal') state.editingProduct = null;
    }


    // ---------------------------------------------------------
    // üñ•Ô∏è UI COMPONENTS
    // ---------------------------------------------------------
    
    // Shared Product Card (Uses Dynamic Theme Icons & Colors)
    const ProductCard = (product) => {
      const theme = getThemeForCategory(product.category);
      return `
      <div class="group relative bg-white rounded-2xl premium-shadow transition-all duration-300 overflow-hidden border border-gray-100 flex flex-col h-full card">
        <div class="aspect-[4/3] w-full overflow-hidden bg-gray-50 relative cursor-pointer" onclick="navigate('product', '${product.slug}')">
          <img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-cover object-center group-hover:scale-110 transition-transform duration-700">
          <div class="absolute inset-0 bg-black/10 group-hover:bg-black/30 transition-all duration-300 flex items-end justify-center opacity-0 group-hover:opacity-100 pb-6">
            <button onclick="addToCart(${JSON.stringify(product).replace(/"/g, '&quot;')}, event)" class="bg-white text-gray-900 px-6 py-3 rounded-full font-bold text-sm transform translate-y-4 group-hover:translate-y-0 transition-all duration-300 hover:bg-gray-100 shadow-xl flex items-center gap-2">
              ${Icon.Cart()} Quick Add
            </button>
          </div>
        </div>
        <div class="p-5 flex flex-col flex-grow">
          <div class="mb-2">
             <span class="inline-flex items-center gap-1 text-[11px] font-extrabold tracking-wider uppercase px-2 py-1 rounded-md border" 
                   style="color: ${theme.primary}; background-color: ${theme.primary}10; border-color: ${theme.primary}20;">
                   <span>${theme.icon}</span> ${product.category || 'Item'}
             </span>
          </div>
          <h3 class="text-lg font-bold text-gray-900 mb-1 hover:text-[${theme.primary}] transition-colors line-clamp-2 leading-tight cursor-pointer" 
              onclick="navigate('product', '${product.slug}')"
              onmouseover="this.style.color='${theme.primary}'" 
              onmouseout="this.style.color=''">
            ${product.name}
          </h3>
          <p class="text-sm text-gray-500 line-clamp-2 mb-4 flex-grow leading-relaxed">${product.description}</p>
          <div class="flex items-end justify-between pt-4 border-t border-dashed border-gray-100 mt-auto">
            <div>
                <span class="block text-xs text-gray-400 font-medium mb-0.5">Price</span>
                <span class="text-2xl font-extrabold text-gray-900">$${product.price.toFixed(2)}</span>
            </div>
            <button onclick="addToCart(${JSON.stringify(product).replace(/"/g, '&quot;')}, event)" 
                    class="p-3 rounded-xl text-white transition-all shadow-sm hover:shadow-md hover:-translate-y-1"
                    style="background-color: ${theme.primary};"
                    onmouseover="this.style.backgroundColor='${theme.secondary}'"
                    onmouseout="this.style.backgroundColor='${theme.primary}'">
              ${Icon.Plus()}
            </button>
          </div>
        </div>
      </div>
    `};

    const AdminProductRow = (p) => {
        const theme = getThemeForCategory(p.category);
        return `
        <tr class="hover:bg-gray-50 transition-colors group border-b border-gray-100 last:border-0">
            <td class="p-4 flex items-center gap-4">
            <img src="${p.image_url}" class="w-14 h-14 rounded-xl object-cover bg-gray-100 border border-gray-200 shadow-sm">
            <div>
                <span class="block font-bold text-gray-900">${p.name}</span>
                <span class="text-xs text-gray-400">${p.slug}</span>
            </div>
            </td>
            <td class="p-4 text-gray-900 font-semibold">$${p.price.toFixed(2)}</td>
            <td class="p-4">
                <span class="px-3 py-1 text-xs rounded-full font-bold uppercase tracking-wider flex items-center gap-1 w-fit"
                      style="color: ${theme.primary}; background-color: ${theme.primary}15;">
                   ${theme.icon} ${p.category}
                </span>
            </td>
            <td class="p-4 text-right whitespace-nowrap">
                <button onclick="openEditModal('${p.id}')" class="text-indigo-600 hover:text-indigo-900 p-2 rounded-lg hover:bg-indigo-50 transition-colors mr-2">
                    ${Icon.Edit()}
                </button>
                <button onclick="handleDeleteProduct('${p.id}')" class="text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition-colors">
                    ${Icon.Trash()}
                </button>
            </td>
        </tr>
    `};

    // ---------------------------------------------------------
    // üìÑ PAGE RENDERERS
    // ---------------------------------------------------------

    function renderHomePage() {
      return `
        <div class="relative theme-bg-primary text-white overflow-hidden mb-16 rounded-b-[3rem] shadow-2xl page-enter transition-colors duration-500">
           <div class="absolute inset-0 bg-gradient-to-br from-black/20 via-transparent to-black/40"></div>
           <div class="absolute inset-0 bg-[url('https://images.unsplash.com/photo-1441986300917-64674bd600d8?ixlib=rb-1.2.1&auto=format&fit=crop&w=1950&q=80')] bg-cover bg-center mix-blend-overlay opacity-30"></div>
           
           <div class="relative max-w-7xl mx-auto px-6 py-32 text-center">
             <span class="inline-block bg-white/10 backdrop-blur-md border border-white/20 px-4 py-1 rounded-full text-xs font-bold tracking-widest uppercase mb-6">New Season</span>
             <h1 class="text-5xl md:text-7xl font-extrabold mb-6 tracking-tight leading-tight">Premium Gear<br>For Modern Life.</h1>
             <p class="text-xl text-gray-200 mb-10 max-w-2xl mx-auto leading-relaxed">Curated essentials tailored for quality, functionality, and style.</p>
             <button onclick="document.getElementById('shop-section').scrollIntoView({behavior: 'smooth'})" class="bg-white text-gray-900 px-10 py-4 rounded-full font-bold hover:bg-gray-50 transition-all transform hover:scale-105 shadow-xl">
                 Start Shopping
             </button>
           </div>
        </div>

        <div id="shop-section" class="max-w-7xl mx-auto px-4 pb-24 space-y-20">
            <section>
                <div class="flex items-center justify-between mb-10">
                    <div>
                        <h2 class="text-3xl font-extrabold text-gray-900">Monthly Deals</h2>
                        <p class="text-gray-500 mt-1">Limited-time offers on top-tier products.</p>
                    </div>
                    <a href="#" onclick="return false;" class="group flex items-center gap-2 theme-text-primary font-bold hover:brightness-110 transition-colors">
                        View all <span class="group-hover:translate-x-1 transition-transform">‚Üí</span>
                    </a>
                </div>
                <div class="flex overflow-x-auto snap-x gap-8 pb-12 scrollbar-hide -mx-4 px-4 grid-stagger">
                    ${state.products.slice(0, 6).map(product => `
                        <div class="min-w-[300px] w-[300px] snap-start h-full">
                            ${ProductCard(product)}
                        </div>
                    `).join('')}
                </div>
            </section>

            <section>
                <div class="mb-10 text-center">
                    <h2 class="text-3xl font-extrabold text-gray-900 mb-3">Our Bestsellers</h2>
                    <p class="text-gray-500 max-w-xl mx-auto">Customer favorites that define excellence.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8 grid-stagger">
                    ${state.products.slice(0, 8).map(product => ProductCard(product)).join('')}
                </div>
            </section>
        </div>
      `;
    }

    function ProductPage() {
      const product = state.products.find(p => p.slug === state.currentSlug);
      if (!product) return '<div class="min-h-[60vh] flex items-center justify-center"><div class="text-2xl font-bold text-gray-400">Product not found</div></div>';
      
      const theme = getThemeForCategory(product.category);
      const productJson = JSON.stringify(product).replace(/"/g, '&quot;');

      return `
        <div class="max-w-7xl mx-auto px-4 py-12 page-enter relative">
          <button 
              onclick="navigate('home'); return false;" 
              class="absolute top-12 left-4 md:left-0 mb-8 flex items-center gap-3 text-gray-500 hover:text-gray-900 transition-colors z-50-click group bg-white/80 backdrop-blur-sm p-2 rounded-full md:bg-transparent md:p-0"
          >
              <div class="p-2 rounded-full bg-white shadow-sm group-hover:shadow-md transition-all ring-1 ring-gray-100">
                  ${Icon.ChevronLeft()}
              </div>
              <span class="font-bold hidden md:inline">Back to Shopping</span>
          </button>

          <div class="grid md:grid-cols-2 gap-16 mt-20 md:mt-12">
            <div class="bg-white rounded-3xl premium-shadow border-2 overflow-hidden p-8 flex items-center justify-center bg-gray-50 h-[50vh] md:h-auto sticky top-24 transition-colors duration-500"
                 style="border-color: ${theme.primary}">
               <img src="${product.image_url}" class="w-full h-full object-contain hover:scale-105 transition-transform duration-500">
            </div>
            
            <div class="flex flex-col justify-center py-8">
               <div class="mb-6">
                <span class="inline-flex items-center gap-2 text-xs font-extrabold tracking-widest uppercase bg-gray-100 px-3 py-1.5 rounded-md mb-4"
                      style="color: ${theme.primary}; background-color: ${theme.primary}15;">
                   ${theme.icon} ${product.category}
                </span>
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4 leading-tight">${product.name}</h1>
               </div>
               
               <p class="text-4xl font-black mb-8 flex items-baseline gap-2" style="color: ${theme.primary}">
                $${product.price.toFixed(2)}
               </p>
               
               <div class="prose prose-lg text-gray-600 mb-10 leading-relaxed">
                <p>${product.description}</p>
               </div>
               
               <div class="flex items-center gap-4 border-t border-gray-100 pt-8">
                   <button onclick="addToCart(${productJson}, event)" 
                           class="flex-1 text-white px-8 py-5 rounded-2xl font-bold text-xl transition-all shadow-xl hover:shadow-2xl hover:-translate-y-1 flex items-center justify-center gap-3"
                           style="background-color: ${theme.primary}">
                      ${Icon.Cart()} Add to Cart
                   </button>
               </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderAuthPage() {
      const isLogin = state.authMode === 'login';
      return `
        <div class="min-h-[90vh] flex items-center justify-center px-4 page-enter bg-gray-50">
          <div class="bg-white p-10 rounded-3xl premium-shadow w-full max-w-[480px] border border-gray-100 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 theme-bg-primary"></div>

            <div class="text-center mb-10">
              <h1 class="text-4xl font-extrabold text-gray-900 mb-3">${isLogin ? 'Welcome Back' : 'Create Account'}</h1>
              <p class="text-gray-500 text-lg">Enter your details to access your account</p>
            </div>

            <form onsubmit="handleAuth(event)" class="space-y-6">
              <div class="space-y-2">
                <label class="block text-sm font-bold text-gray-900 pl-1">Email Address</label>
                <input type="email" name="email" required class="w-full px-5 py-4 rounded-xl bg-gray-50 border-2 border-gray-100 focus:bg-white theme-border-primary focus:ring-0 outline-none transition-all font-medium placeholder-gray-400" placeholder="name@example.com">
              </div>

              <div class="space-y-2">
                <label class="block text-sm font-bold text-gray-900 pl-1 flex justify-between">
                    Password
                </label>
                <input type="password" name="password" required class="w-full px-5 py-4 rounded-xl bg-gray-50 border-2 border-gray-100 focus:bg-white theme-border-primary focus:ring-0 outline-none transition-all font-medium placeholder-gray-400" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
              </div>

              <button type="submit" class="w-full btn-primary text-white font-bold text-lg py-4 rounded-xl shadow-xl hover:shadow-2xl mt-8">
                ${isLogin ? 'Sign In' : 'Create Account'}
              </button>
            </form>

            <div class="mt-8 text-center">
              <p class="text-gray-600 font-medium">
                ${isLogin ? "New to ShopHub?" : "Already have an account?"}
                <button onclick="setAuthMode('${isLogin ? 'signup' : 'login'}')" class="font-bold theme-text-primary hover:brightness-110 ml-2 underline-offset-2 hover:underline transition-all">
                  ${isLogin ? 'Create an account' : 'Log in now'}
                </button>
              </p>
            </div>
          </div>
        </div>
      `;
    }

    function renderAdminDashboard() {
      if (!state.isAdmin) return `<div class="min-h-[60vh] flex flex-col items-center justify-center page-enter"><div class="text-6xl mb-4">‚õî</div><h1 class="text-3xl font-bold text-gray-900">Access Denied</h1><button onclick="navigate('home')" class="mt-6 theme-text-primary font-bold hover:underline">Go Home</button></div>`;
      
      const knownKeys = Object.keys(CATEGORY_THEMES).filter(k => k !== 'default');
      const categories = state.categories.length > 0 ? state.categories : knownKeys;

      const ModalHeader = (title, id) => `<div class="flex justify-between items-center mb-8 pb-4 border-b border-gray-100"><h3 class="text-2xl font-extrabold text-gray-900">${title}</h3><button onclick="closeModal('${id}')" class="p-2 hover:bg-gray-100 rounded-full transition-colors text-gray-500 hover:text-gray-800">${Icon.Close()}</button></div>`;
      const FormInput = (label, name, type, value='', required=true) => `<div class="space-y-2"><label class="block text-sm font-bold text-gray-900 pl-1">${label}</label><input type="${type}" name="${name}" value="${value}" ${required?'required':''} class="w-full px-5 py-3 rounded-xl bg-gray-50 border-2 border-gray-100 focus:bg-white theme-border-primary focus:ring-0 outline-none transition-all font-medium"></div>`;
      const FormSelect = (label, name, options, sel='') => `<div class="space-y-2"><label class="block text-sm font-bold text-gray-900 pl-1">${label}</label><select name="${name}" class="w-full px-5 py-3 rounded-xl bg-gray-50 border-2 border-gray-100 focus:bg-white theme-border-primary focus:ring-0 outline-none transition-all font-medium">${options.map(c=>`<option value="${c}" ${c===sel?'selected':''}>${c}</option>`).join('')}</select></div>`;

      return `
        <div class="max-w-7xl mx-auto px-4 py-12 page-enter">
          <div class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-4">
            <div>
              <h1 class="text-4xl font-extrabold text-gray-900">Admin Dashboard</h1>
            </div>
            <button onclick="document.getElementById('add-product-modal').showModal()" class="btn-primary text-white px-8 py-4 rounded-xl font-bold text-lg shadow-xl hover:shadow-2xl transition-all flex items-center gap-3 hover:-translate-y-1">
              ${Icon.Plus()} Add New Product
            </button>
          </div>

          <div class="bg-white rounded-3xl premium-shadow border border-gray-100 overflow-hidden">
            <div class="overflow-x-auto">
              <table class="w-full text-left whitespace-nowrap">
                <thead class="bg-gray-50/50 border-b border-gray-100 text-gray-500 font-bold text-xs uppercase tracking-widest">
                  <tr><th class="p-5 pl-6">Product</th><th class="p-5">Price</th><th class="p-5">Category</th><th class="p-5 text-right pr-6">Actions</th></tr>
                </thead>
                <tbody class="divide-y divide-gray-50 bg-white">
                  ${state.products.length > 0 ? state.products.map(p => AdminProductRow(p)).join('') : `<tr><td colspan="4" class="p-8 text-center text-gray-500 font-medium">No products found.</td></tr>`}
                </tbody>
              </table>
            </div>
          </div>

          <dialog id="add-product-modal" class="backdrop:bg-gray-900/60 backdrop:backdrop-blur-sm p-0 rounded-3xl shadow-2xl w-full max-w-2xl m-auto focus:outline-none">
             <div class="p-8 bg-white h-full overflow-y-auto max-h-[90vh] scrollbar-hide">
                ${ModalHeader('Add New Product', 'add-product-modal')}
                <form onsubmit="handleAddProduct(event)" class="space-y-6">
                   ${FormInput('Product Name', 'name', 'text')}
                   <div class="grid grid-cols-2 gap-6">${FormInput('Price', 'price', 'number')}${FormSelect('Category', 'category', categories)}</div>
                   ${FormInput('Image URL', 'image_url', 'url')}
                   <div class="space-y-2"><label class="block text-sm font-bold text-gray-900 pl-1">Description</label><textarea name="description" rows="4" class="w-full px-5 py-3 rounded-xl bg-gray-50 border-2 border-gray-100 focus:bg-white theme-border-primary focus:ring-0 outline-none transition-all font-medium resize-none"></textarea></div>
                   <button type="submit" class="w-full btn-primary text-white font-bold py-4 rounded-xl shadow-lg mt-4">Save Product</button>
                </form>
             </div>
          </dialog>

          <dialog id="edit-product-modal" class="backdrop:bg-gray-900/60 backdrop:backdrop-blur-sm p-0 rounded-3xl shadow-2xl w-full max-w-2xl m-auto focus:outline-none">
             <div class="p-8 bg-white h-full overflow-y-auto max-h-[90vh] scrollbar-hide">
                ${ModalHeader('Edit Product', 'edit-product-modal')}
                ${state.editingProduct ? `<form onsubmit="handleUpdateProduct(event)" class="space-y-6">${FormInput('Product Name', 'name', 'text', state.editingProduct.name)}<div class="grid grid-cols-2 gap-6">${FormInput('Price', 'price', 'number', state.editingProduct.price)}${FormSelect('Category', 'category', categories, state.editingProduct.category)}</div>${FormInput('Image URL', 'image_url', 'url', state.editingProduct.image_url)}<div class="space-y-2"><label class="block text-sm font-bold text-gray-900 pl-1">Description</label><textarea name="description" rows="4" class="w-full px-5 py-3 rounded-xl bg-gray-50 border-2 border-gray-100 focus:bg-white theme-border-primary focus:ring-0 outline-none transition-all font-medium resize-none">${state.editingProduct.description}</textarea></div><div class="pt-4 grid grid-cols-2 gap-4"><button type="button" onclick="closeModal('edit-product-modal')" class="w-full bg-gray-100 text-gray-700 font-bold py-4 rounded-xl hover:bg-gray-200 transition-all">Cancel</button><button type="submit" class="w-full btn-primary text-white font-bold py-4 rounded-xl shadow-lg transition-all">Update Product</button></div></form>` : ''}
             </div>
          </dialog>
        </div>
      `;
    }

    // ---------------------------------------------------------
    // üöÄ MAIN RENDER
    // ---------------------------------------------------------
    function render() {
      const app = document.getElementById('app');
      
      const sidebarHTML = `
        <div class="${state.isSidebarOpen ? 'sidebar-open' : ''} relative z-50">
           <div class="backdrop" onclick="toggleSidebar()"></div>
           <div class="sidebar-wrapper p-8">
              <div class="flex justify-between items-center mb-12">
                 <h2 class="text-3xl font-black theme-text-primary tracking-tighter">ShopHub.</h2>
                 <button onclick="toggleSidebar()" class="p-3 hover:bg-gray-100 rounded-full transition-colors -mr-3 text-gray-500">${Icon.Close()}</button>
              </div>
              <nav class="space-y-3 flex flex-col flex-grow">
                 <button onclick="navigate('home')" class="text-left px-5 py-4 rounded-2xl hover:bg-gray-50 theme-hover-text-primary text-gray-700 font-bold text-lg transition-all flex items-center gap-4 ${state.currentPage === 'home' ? 'bg-gray-50 theme-text-primary' : ''}">Home</button>
                 ${state.isAdmin ? `<button onclick="navigate('admin')" class="text-left px-5 py-4 rounded-2xl hover:bg-gray-50 theme-hover-text-primary text-gray-700 font-bold text-lg transition-all flex items-center gap-4 ${state.currentPage === 'admin' ? 'bg-gray-50 theme-text-primary' : ''}">Admin Dashboard</button>` : ''}
                 <div class="mt-auto pt-8 border-t border-gray-100">
                     ${state.user ? 
                        `<button onclick="handleLogout()" class="w-full text-left px-5 py-4 rounded-2xl bg-red-50 hover:bg-red-100 text-red-600 font-bold text-lg transition-all flex items-center gap-4">Logout<span class="text-xs font-medium opacity-70 truncate ml-auto">${state.user.email.split('@')[0]}</span></button>` : 
                        `<button onclick="navigate('auth')" class="w-full text-center px-8 py-5 rounded-2xl btn-primary text-white font-bold text-lg shadow-xl hover:shadow-2xl transition-all">Sign In / Register</button>`
                     }
                 </div>
              </nav>
           </div>
        </div>
      `;

      const headerHTML = `
         <header class="sticky top-0 z-30 bg-white/80 backdrop-blur-xl border-b border-gray-100/50 shadow-sm transition-colors duration-500">
            <div class="max-w-7xl mx-auto px-4 h-20 flex items-center justify-between">
               <div class="flex items-center gap-4">
                  <button onclick="toggleSidebar()" class="p-3 hover:bg-gray-100/80 rounded-2xl transition-colors text-gray-700 md:hidden">${Icon.Menu()}</button>
                  <span class="text-2xl font-black text-gray-900 tracking-tighter cursor-pointer" onclick="navigate('home')">ShopHub<span class="theme-text-primary">.</span></span>
               </div>
               <nav class="hidden md:flex items-center gap-8 font-bold text-gray-600">
                  <button onclick="navigate('home')" class="theme-hover-text-primary transition-colors">Home</button>
                  <button onclick="document.getElementById('shop-section')?.scrollIntoView({behavior:'smooth'})" class="theme-hover-text-primary transition-colors">Shop</button>
               </nav>
               <div class="flex items-center gap-2">
                  ${!state.user ? `<button onclick="navigate('auth')" class="hidden md:block font-bold theme-text-primary hover:bg-gray-50 px-6 py-3 rounded-2xl transition-all mr-2">Sign In</button>` : ''}
                  <button class="p-3 hover:bg-gray-50 text-gray-700 theme-hover-text-primary rounded-2xl relative transition-all group" onclick="navigate('cart')">
                     <div class="group-hover:scale-110 transition-transform">${Icon.Cart()}</div>
                     ${state.cart.length > 0 ? `<span class="absolute top-2 right-2 w-5 h-5 bg-red-500 text-white text-[10px] flex items-center justify-center rounded-full font-extrabold border-2 border-white transform translate-x-1 -translate-y-1">${state.cart.reduce((a, b) => a + b.quantity, 0)}</span>` : ''}
                  </button>
               </div>
            </div>
         </header>
      `;

      let content = '';
      switch (state.currentPage) {
          case 'home': content = renderHomePage(); break;
          case 'product': content = ProductPage(); break;
          case 'auth': content = renderAuthPage(); break;
          case 'admin': content = renderAdminDashboard(); break;
          case 'cart': content = `<div class="p-12 text-center min-h-[50vh] flex flex-col items-center justify-center"><div class="text-6xl mb-4">üõí</div><h1 class="text-3xl font-bold mb-2">Your Cart is Empty</h1><button onclick="navigate('home')" class="mt-8 btn-primary text-white px-8 py-4 rounded-full font-bold shadow-lg transition-all">Browse Products</button></div>`;
          default: content = renderHomePage();
      }

      app.innerHTML = sidebarHTML + headerHTML + `<main class="min-h-screen pb-20">${content}</main>`;
      
      const dialogs = document.querySelectorAll('dialog');
      dialogs.forEach(dialog => {
          dialog.addEventListener('click', (e) => {
              const rect = dialog.getBoundingClientRect();
              if (e.clientY < rect.top || e.clientY > rect.bottom || e.clientX < rect.left || e.clientX > rect.right) dialog.close();
          });
      });
    }

    // ---------------------------------------------------------
    // üèÅ INITIALIZATION
    // ---------------------------------------------------------
    async function init() {
        await fetchProducts();
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'TOKEN_REFRESHED') return;
            state.user = session?.user || null;
            if (state.user && state.user.email) {
                const userEmail = state.user.email.trim().toLowerCase();
                const adminEmail = typeof ADMIN_EMAIL !== 'undefined' ? ADMIN_EMAIL.trim().toLowerCase() : '';
                state.isAdmin = userEmail === adminEmail && adminEmail !== '';
            } else state.isAdmin = false;

            if (state.user) { await fetchCart(); if (state.currentPage === 'auth') navigate('home'); }
            else { state.cart = []; if (state.currentPage === 'admin') navigate('home'); }
            render();
        });
    }

    // Expose Globals
    window.navigate = navigate;
    window.addToCart = addToCart;
    window.toggleSidebar = toggleSidebar;
    window.handleAddProduct = handleAddProduct;
    window.handleUpdateProduct = handleUpdateProduct;
    window.handleDeleteProduct = handleDeleteProduct;
    window.handleAuth = handleAuth;
    window.handleLogout = handleLogout;
    window.setAuthMode = setAuthMode;
    window.openEditModal = openEditModal;
    window.closeModal = closeModal;

    init();
  </script>
</body>
</html>
