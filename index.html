<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShopHub - Premium Online Store</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* üé® Premium Color Palette & Base Styling */
    :root {
      /* Default Global Colors */
      --default-primary: #001f3f;
      --default-secondary: #004d40;
      
      /* Active Variables (These change dynamically via JS) */
      --color-primary: var(--default-primary);
      --color-secondary: var(--default-secondary);
      --color-accent: #ffd700; /* Gold */
    }

    /* Transition for color changes */
    body, button, header, footer, div {
      transition: background-color 0.5s ease, color 0.5s ease, border-color 0.5s ease;
    }

    /* Tailwind Overrides */
    .bg-indigo-600 { background-color: var(--color-primary); }
    .hover\:bg-indigo-700:hover { background-color: var(--color-secondary); }
    .text-indigo-600 { color: var(--color-primary); }
    .text-indigo-700 { color: var(--color-secondary); }
    
    /* ‚öôÔ∏è Toggle Switch Styles */
    .toggle-checkbox:checked {
      right: 0;
      border-color: #68D391;
    }
    .toggle-checkbox:checked + .toggle-label {
      background-color: #68D391;
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-900">

  <!-- üõçÔ∏è APP CONTAINER -->
  <div id="app"></div>

  <!-- üìú JAVASCRIPT LOGIC -->
  <script>
    // --- CONFIGURATION ---
    const SUPABASE_URL = 'https://thzmryhnyzhfewsyamjh.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRoem1yeWhueXpoZmV3c3lhbWpoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ3NTgwMTAsImV4cCI6MjA4MDMzNDAxMH0.qvCid4pmsdcRogce4RZH5adl90Eq5d3ibwVoJI5qr-I'; // ‚ö†Ô∏è REPLACE WITH YOUR ACTUAL KEY
    const ADMIN_EMAIL = 'utkwholesale.sup@gmail.com'; // üëë Admin Email

    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // --- STATE MANAGEMENT ---
    const state = {
      user: null,
      isAdmin: false,
      currentPage: 'home', // home, cart, login, admin
      products: [],
      adminProducts: [], // Separate list for admin view
      categories: [],
      cart: [],
      menuOpen: false,
      authMode: 'login', // login, signup
      adminCategoryFilter: 'all', // For filtering admin list
      editingProduct: null, // Holds the product currently being edited
    };

    // --- MAIN RENDER FUNCTION ---
    function render() {
      const app = document.getElementById('app');
      app.innerHTML = `
        ${renderHeader()}
        <main class="min-h-screen pt-20 pb-10 px-4 max-w-7xl mx-auto">
          ${renderContent()}
        </main>
        ${renderFooter()}
      `;
      
      // Re-attach event listeners for "Deal" logic if in Admin view
      if (state.currentPage === 'admin') {
          attachAdminListeners();
      }
    }

    // --- COMPONENT RENDERS ---

    function renderHeader() {
      const cartCount = state.cart.reduce((sum, item) => sum + item.quantity, 0);
      return `
        <header class="fixed w-full top-0 z-50 bg-white shadow-md">
          <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
              <div class="flex items-center cursor-pointer" onclick="navigate('home')">
                <span class="text-2xl font-bold text-indigo-600">ShopHub</span>
              </div>
              
              <!-- Desktop Nav -->
              <div class="hidden md:flex items-center space-x-8">
                <a href="#" onclick="navigate('home')" class="text-gray-700 hover:text-indigo-600">Home</a>
                ${state.isAdmin ? `<a href="#" onclick="navigate('admin')" class="text-red-600 font-bold hover:text-red-800">Admin Dashboard</a>` : ''}
                
                <div class="relative cursor-pointer" onclick="navigate('cart')">
                  <span class="text-2xl">üõí</span>
                  ${cartCount > 0 ? `<span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">${cartCount}</span>` : ''}
                </div>

                ${state.user 
                  ? `<button onclick="handleLogout()" class="text-gray-700 hover:text-indigo-600">Logout (${state.user.email.split('@')[0]})</button>`
                  : `<button onclick="navigate('login')" class="bg-indigo-600 text-white px-4 py-2 rounded hover:bg-indigo-700">Login</button>`
                }
              </div>

              <!-- Mobile Menu Button -->
              <div class="md:hidden flex items-center">
                <button onclick="toggleMenu()" class="text-gray-700 focus:outline-none">
                  <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="${state.menuOpen ? 'M6 18L18 6M6 6l12 12' : 'M4 6h16M4 12h16M4 18h16'}"/>
                  </svg>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Mobile Menu -->
          ${state.menuOpen ? `
            <div class="md:hidden bg-white border-t">
              <a href="#" onclick="navigate('home')" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Home</a>
              ${state.isAdmin ? `<a href="#" onclick="navigate('admin')" class="block px-4 py-2 text-red-600 font-bold hover:bg-gray-100">Admin Dashboard</a>` : ''}
              <a href="#" onclick="navigate('cart')" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">Cart (${cartCount})</a>
              ${state.user 
                ? `<button onclick="handleLogout()" class="block w-full text-left px-4 py-2 text-gray-700 hover:bg-gray-100">Logout</button>` 
                : `<button onclick="navigate('login')" class="block w-full text-left px-4 py-2 text-indigo-600 font-bold hover:bg-gray-100">Login</button>`
              }
            </div>
          ` : ''}
        </header>
      `;
    }

    function renderContent() {
      if (state.currentPage === 'home') return renderHome();
      if (state.currentPage === 'cart') return renderCart();
      if (state.currentPage === 'login') return renderLogin();
      if (state.currentPage === 'admin') return renderAdmin();
      return '';
    }

    function renderFooter() {
      return `
        <footer class="bg-gray-800 text-white py-8 mt-10">
          <div class="max-w-7xl mx-auto px-4 text-center">
            <p>&copy; 2023 ShopHub. All rights reserved.</p>
          </div>
        </footer>
      `;
    }

    // --- PAGE: HOME ---
    function renderHome() {
      // Group products by category
      const categoriesWithProducts = state.categories.map(cat => ({
        ...cat,
        products: state.products.filter(p => p.category_id === cat.id)
      })).filter(group => group.products.length > 0);

      return `
        <div class="space-y-12">
          <!-- Hero Section -->
          <div class="bg-indigo-600 rounded-2xl p-8 md:p-12 text-center text-white shadow-xl">
            <h1 class="text-4xl md:text-5xl font-bold mb-4">Welcome to ShopHub</h1>
            <p class="text-lg md:text-xl opacity-90 mb-8">Premium products delivered to your doorstep.</p>
          </div>

          ${categoriesWithProducts.map(cat => `
            <section>
              <h2 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">${cat.name}</h2>
              <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                ${cat.products.map(product => renderProductCard(product)).join('')}
              </div>
            </section>
          `).join('')}
          
          ${categoriesWithProducts.length === 0 ? `<p class="text-center text-gray-500">No products available.</p>` : ''}
        </div>
      `;
    }

    function renderProductCard(product) {
      // Logic to show deal price if applicable
      const hasDeal = product.is_deal && product.deal_price > product.price;
      const discount = hasDeal ? Math.round(((product.deal_price - product.price) / product.deal_price) * 100) : 0;

      return `
        <div class="bg-white rounded-xl shadow-lg hover:shadow-xl transition-shadow duration-300 overflow-hidden flex flex-col h-full group border border-gray-100">
          <div class="relative h-48 overflow-hidden bg-gray-200">
            <img src="${product.image_url}" alt="${product.name}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" onerror="this.src='https://via.placeholder.com/400?text=No+Image'">
            ${product.is_bestseller ? `<span class="absolute top-2 left-2 bg-yellow-400 text-yellow-900 text-xs font-bold px-2 py-1 rounded-full shadow">Bestseller</span>` : ''}
            ${hasDeal ? `<span class="absolute top-2 right-2 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full shadow">-${discount}%</span>` : ''}
          </div>
          <div class="p-5 flex-grow flex flex-col">
            <h3 class="text-lg font-bold text-gray-900 mb-1">${product.name}</h3>
            <p class="text-sm text-gray-500 mb-4 line-clamp-2">${product.description}</p>
            <div class="mt-auto flex items-center justify-between">
              <div>
                ${hasDeal 
                  ? `<span class="text-gray-400 line-through text-sm mr-1">$${product.deal_price}</span> <span class="text-xl font-bold text-red-600">$${product.price}</span>`
                  : `<span class="text-xl font-bold text-indigo-600">$${product.price}</span>`
                }
              </div>
              <button onclick="addToCart('${product.id}')" class="bg-indigo-600 text-white p-2 rounded-full hover:bg-indigo-700 shadow-md transition-transform active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      `;
    }

    // --- PAGE: CART ---
    function renderCart() {
      if (state.cart.length === 0) {
        return `
          <div class="text-center py-20">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Your cart is empty</h2>
            <button onclick="navigate('home')" class="text-indigo-600 hover:underline">Continue Shopping</button>
          </div>
        `;
      }

      const total = state.cart.reduce((sum, item) => sum + (item.product.price * item.quantity), 0);

      return `
        <h2 class="text-3xl font-bold mb-8">Shopping Cart</h2>
        <div class="flex flex-col lg:flex-row gap-8">
          <!-- Cart Items -->
          <div class="flex-grow space-y-4">
            ${state.cart.map(item => `
              <div class="flex items-center justify-between bg-white p-4 rounded-lg shadow">
                <div class="flex items-center space-x-4">
                  <img src="${item.product.image_url}" class="w-16 h-16 object-cover rounded bg-gray-100" onerror="this.src='https://via.placeholder.com/150'">
                  <div>
                    <h3 class="font-bold">${item.product.name}</h3>
                    <p class="text-gray-500">$${item.product.price}</p>
                  </div>
                </div>
                <div class="flex items-center space-x-4">
                  <div class="flex items-center border rounded">
                    <button onclick="updateQuantity('${item.id}', ${item.quantity - 1})" class="px-3 py-1 hover:bg-gray-100">-</button>
                    <span class="px-3 py-1 border-x">${item.quantity}</span>
                    <button onclick="updateQuantity('${item.id}', ${item.quantity + 1})" class="px-3 py-1 hover:bg-gray-100">+</button>
                  </div>
                  <button onclick="removeFromCart('${item.id}')" class="text-red-500 hover:text-red-700">
                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
          
          <!-- Summary -->
          <div class="w-full lg:w-80 h-fit bg-white p-6 rounded-lg shadow">
            <h3 class="text-xl font-bold mb-4">Order Summary</h3>
            <div class="flex justify-between mb-4 text-lg font-bold">
              <span>Total</span>
              <span>$${total.toFixed(2)}</span>
            </div>
            <button onclick="alert('Checkout functionality coming soon!')" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 font-bold shadow-lg">
              Checkout
            </button>
          </div>
        </div>
      `;
    }

    // --- PAGE: ADMIN ---
    function renderAdmin() {
      // 1. Filter Logic
      const filteredProducts = state.adminCategoryFilter === 'all' 
          ? state.adminProducts 
          : state.adminProducts.filter(p => p.category_id === state.adminCategoryFilter);

      // 2. Edit Mode values
      const isEditing = !!state.editingProduct;
      const p = state.editingProduct || {}; // shorthand

      return `
        <div class="max-w-4xl mx-auto space-y-10">
          <div class="flex justify-between items-center">
            <h2 class="text-3xl font-bold text-gray-800">Admin Dashboard</h2>
            <div class="text-sm text-gray-500">Logged in as: <span class="font-mono text-indigo-600">${state.user?.email}</span></div>
          </div>

          <!-- üìù ADD / EDIT PRODUCT FORM -->
          <div class="bg-white p-6 rounded-xl shadow-lg border-t-4 ${isEditing ? 'border-yellow-500' : 'border-indigo-600'}" id="product-form-container">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold ${isEditing ? 'text-yellow-600' : 'text-gray-800'}">
                    ${isEditing ? '‚úèÔ∏è Edit Product' : '‚ú® Add New Product'}
                </h3>
                ${isEditing ? `<button onclick="cancelEdit()" class="text-sm text-gray-500 hover:text-red-500 underline">Cancel Edit</button>` : ''}
            </div>

            <form onsubmit="handleSaveProduct(event)" class="space-y-5">
              <input type="hidden" name="id" value="${p.id || ''}">
              
              <!-- Name & Slug -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Product Name</label>
                  <input type="text" name="name" required value="${p.name || ''}" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. Wireless Mouse">
                </div>
                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-1">Slug (URL)</label>
                  <input type="text" name="slug" required value="${p.slug || ''}" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="e.g. wireless-mouse-v2">
                </div>
              </div>

              <!-- Category -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Category</label>
                <select name="category_id" required class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none bg-white">
                  <option value="" disabled ${!p.category_id ? 'selected' : ''}>Select Category...</option>
                  ${state.categories.map(cat => `<option value="${cat.id}" ${p.category_id === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')}
                </select>
              </div>

              <!-- Price Section -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Selling Price ($)</label>
                    <input type="number" step="0.01" id="input-price" name="price" required value="${p.price || ''}" class="w-full border rounded-lg px-4 py-2 text-lg font-bold text-indigo-700 outline-none">
                </div>
                
                <!-- Dynamic Original Price (Hidden unless Deal is active) -->
                <div id="deal-price-container" class="${p.is_deal ? '' : 'hidden'}">
                    <label class="block text-sm font-medium text-gray-500 mb-1">Original Price (Strikethrough)</label>
                    <input type="number" step="0.01" id="input-deal-price" name="deal_price" value="${p.deal_price || ''}" class="w-full border rounded-lg px-4 py-2 text-gray-500 line-through outline-none">
                </div>
              </div>
              
              <!-- Calculated Discount Badge -->
              <div id="discount-badge-container" class="flex justify-end ${p.is_deal ? '' : 'hidden'}">
                 <span id="discount-badge" class="bg-red-100 text-red-600 px-3 py-1 rounded-full text-sm font-bold">0% OFF</span>
              </div>

              <!-- TOGGLES -->
              <div class="flex space-x-8 py-2">
                <!-- Bestseller Toggle -->
                <label class="flex items-center cursor-pointer">
                  <div class="relative">
                    <input type="checkbox" name="is_bestseller" class="sr-only toggle-checkbox" ${p.is_bestseller ? 'checked' : ''}>
                    <div class="w-10 h-6 bg-gray-200 rounded-full shadow-inner toggle-label transition-colors"></div>
                    <div class="dot absolute w-4 h-4 bg-white rounded-full shadow -left-1 -top-1 transition-transform transform translate-x-full translate-y-full" style="top: 0.25rem; left: 0.25rem;"></div>
                  </div>
                  <div class="ml-3 text-gray-700 font-medium">Bestseller</div>
                </label>

                <!-- Monthly Deal Toggle -->
                <label class="flex items-center cursor-pointer">
                  <div class="relative">
                    <input type="checkbox" id="toggle-deal" name="is_deal" class="sr-only toggle-checkbox" ${p.is_deal ? 'checked' : ''}>
                    <div class="w-10 h-6 bg-gray-200 rounded-full shadow-inner toggle-label transition-colors"></div>
                    <div class="dot absolute w-4 h-4 bg-white rounded-full shadow left-1 top-1 transition-transform"></div>
                  </div>
                  <div class="ml-3 text-gray-700 font-medium">Monthly Deal</div>
                </label>
              </div>

              <!-- Description -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                <textarea name="description" required rows="3" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none">${p.description || ''}</textarea>
              </div>

              <!-- Image URL -->
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                <input type="url" name="image_url" required value="${p.image_url || ''}" class="w-full border rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="https://...">
              </div>

              <button type="submit" class="w-full ${isEditing ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-indigo-600 hover:bg-indigo-700'} text-white font-bold py-3 rounded-lg shadow transition-colors">
                ${isEditing ? 'Update Product' : 'Add Product'}
              </button>
            </form>
          </div>

          <!-- üìã PRODUCT LIST -->
          <div>
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800">Your Products</h3>
                
                <!-- Category Filter -->
                <select onchange="filterAdminProducts(this.value)" class="mt-4 md:mt-0 border border-gray-300 rounded-lg px-4 py-2 bg-white text-gray-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="all" ${state.adminCategoryFilter === 'all' ? 'selected' : ''}>All Categories</option>
                    ${state.categories.map(cat => `<option value="${cat.id}" ${state.adminCategoryFilter === cat.id ? 'selected' : ''}>${cat.name}</option>`).join('')}
                </select>
            </div>

            <div class="bg-white rounded-xl shadow overflow-hidden">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Image</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Category</th>
                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  ${filteredProducts.length === 0 ? `<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No products found.</td></tr>` : ''}
                  ${filteredProducts.map(product => {
                    const catName = state.categories.find(c => c.id === product.category_id)?.name || 'Unknown';
                    return `
                      <tr>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <img class="h-10 w-10 rounded object-cover bg-gray-100" src="${product.image_url}" onerror="this.src='https://via.placeholder.com/40'">
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                          <div class="text-sm font-medium text-gray-900">${product.name}</div>
                          <div class="text-xs text-gray-500">${product.slug}</div>
                          ${product.is_deal ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">Deal</span>` : ''}
                          ${product.is_bestseller ? `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">Bestseller</span>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                          $${product.price}
                          ${product.is_deal ? `<div class="line-through text-xs text-red-300">$${product.deal_price}</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${catName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-2">
                          <button onclick="handleEditProduct('${product.id}')" class="text-indigo-600 hover:text-indigo-900 bg-indigo-50 px-3 py-1 rounded">Edit</button>
                          <button onclick="handleDeleteProduct('${product.id}')" class="text-red-600 hover:text-red-900 bg-red-50 px-3 py-1 rounded">Delete</button>
                        </td>
                      </tr>
                    `;
                  }).join('')}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      `;
    }

    function renderLogin() {
      const isLogin = state.authMode === 'login';
      return `
        <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg mt-10">
          <h2 class="text-2xl font-bold mb-6 text-center text-indigo-600">${isLogin ? 'Login to ShopHub' : 'Create Account'}</h2>
          
          <form onsubmit="handleAuth(event)" class="space-y-4">
            <div>
              <label class="block text-gray-700 mb-1">Email</label>
              <input type="email" name="email" required class="w-full border rounded px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div>
              <label class="block text-gray-700 mb-1">Password</label>
              <input type="password" name="password" required minlength="6" class="w-full border rounded px-3 py-2 outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <button type="submit" class="w-full bg-indigo-600 text-white py-2 rounded hover:bg-indigo-700 transition">
              ${isLogin ? 'Sign In' : 'Sign Up'}
            </button>
          </form>

          <div class="mt-4 text-center">
            <p class="text-sm text-gray-600">
              ${isLogin ? "Don't have an account?" : "Already have an account?"} 
              <button onclick="setAuthMode('${isLogin ? 'signup' : 'login'}')" class="text-indigo-600 font-bold hover:underline">
                ${isLogin ? 'Sign Up' : 'Login'}
              </button>
            </p>
          </div>
          
          <div class="mt-6 border-t pt-4">
            <button onclick="handleGoogleLogin()" class="w-full flex justify-center items-center border py-2 rounded hover:bg-gray-50 transition">
              <span class="mr-2">Sign in with Google</span>
            </button>
          </div>
        </div>
      `;
    }

    // --- LOGIC FUNCTIONS ---

    function navigate(page) {
      state.currentPage = page;
      state.menuOpen = false;
      
      if (page === 'admin') {
        if (!state.isAdmin) {
           alert("Access Denied: You are not an admin.");
           navigate('home');
           return;
        }
        fetchAdminProducts(); // Refresh products when entering admin
      }
      
      render();
    }

    function toggleMenu() {
      state.menuOpen = !state.menuOpen;
      render();
    }

    // --- CART LOGIC ---
    async function fetchCart() {
      if (!state.user) return;
      const { data, error } = await supabase.from('cart_items').select('*, product:products(*)').eq('user_id', state.user.id);
      if (data) state.cart = data;
    }

    async function mergeCart() {
        // Simple merge logic placeholder
    }

    async function addToCart(productId) {
      if (!state.user) {
        alert("Please login to add items to cart.");
        navigate('login');
        return;
      }
      
      const existing = state.cart.find(item => item.product_id === productId);
      if (existing) {
        updateQuantity(existing.id, existing.quantity + 1);
      } else {
        const { error } = await supabase.from('cart_items').insert({ user_id: state.user.id, product_id: productId, quantity: 1 });
        if (!error) await fetchCart();
      }
      render();
    }

    async function updateQuantity(itemId, newQty) {
      if (newQty < 1) {
        removeFromCart(itemId);
        return;
      }
      const { error } = await supabase.from('cart_items').update({ quantity: newQty }).eq('id', itemId);
      if (!error) await fetchCart();
      render();
    }

    async function removeFromCart(itemId) {
      if (!confirm('Remove this item?')) return;
      const { error } = await supabase.from('cart_items').delete().eq('id', itemId);
      if (!error) await fetchCart();
      render();
    }

    // --- ADMIN LOGIC ---

    async function fetchAdminProducts() {
        const { data, error } = await supabase.from('products').select('*').order('created_at', { ascending: false });
        if (data) {
            state.adminProducts = data;
            render();
        }
    }

    // üåü Helper for the Deal UI Logic
    function attachAdminListeners() {
        const toggleDeal = document.getElementById('toggle-deal');
        const priceInput = document.getElementById('input-price');
        const dealPriceInput = document.getElementById('input-deal-price');
        const dealContainer = document.getElementById('deal-price-container');
        const badgeContainer = document.getElementById('discount-badge-container');
        const badge = document.getElementById('discount-badge');

        function updateCalculations() {
            if (toggleDeal.checked) {
                dealContainer.classList.remove('hidden');
                badgeContainer.classList.remove('hidden');
                
                const current = parseFloat(priceInput.value) || 0;
                const original = parseFloat(dealPriceInput.value) || 0;
                
                if (original > current && original > 0) {
                    const percent = Math.round(((original - current) / original) * 100);
                    badge.textContent = `${percent}% OFF`;
                } else {
                    badge.textContent = `0% OFF`;
                }
            } else {
                dealContainer.classList.add('hidden');
                badgeContainer.classList.add('hidden');
            }
        }

        if (toggleDeal) {
            toggleDeal.addEventListener('change', updateCalculations);
            priceInput.addEventListener('input', updateCalculations);
            dealPriceInput.addEventListener('input', updateCalculations);
            // Run once on load to set initial state
            updateCalculations();
        }
    }

    // üåü Filter Logic
    function filterAdminProducts(categoryId) {
        state.adminCategoryFilter = categoryId;
        render();
    }

    // üåü Edit Click
    function handleEditProduct(id) {
        const product = state.adminProducts.find(p => p.id === id);
        if (product) {
            state.editingProduct = product;
            render();
            // Scroll to form
            document.getElementById('product-form-container').scrollIntoView({ behavior: 'smooth' });
        }
    }

    function cancelEdit() {
        state.editingProduct = null;
        render();
    }

    // üåü Delete Click
    async function handleDeleteProduct(id) {
        if (!confirm("Are you sure you want to permanently delete this product?")) return;
        
        const { error } = await supabase.from('products').delete().eq('id', id);
        
        if (error) {
            alert("Error deleting: " + error.message);
        } else {
            // Optimistic update
            state.adminProducts = state.adminProducts.filter(p => p.id !== id);
            state.products = state.products.filter(p => p.id !== id); // update home list too
            render();
        }
    }

    // üåü Save (Add OR Update)
    async function handleSaveProduct(e) {
      e.preventDefault();
      
      if (!state.isAdmin) {
          alert("Action Blocked: You are not logged in as Admin.");
          return;
      }

      const formData = new FormData(e.target);
      const isDeal = formData.get('is_deal') === 'on';

      const productData = {
        name: formData.get('name'),
        slug: formData.get('slug'),
        description: formData.get('description'),
        price: parseFloat(formData.get('price')),
        category_id: formData.get('category_id'),
        image_url: formData.get('image_url'),
        is_bestseller: formData.get('is_bestseller') === 'on',
        is_deal: isDeal,
        deal_price: isDeal ? parseFloat(formData.get('deal_price')) : null,
        is_active: true
      };
      
      // If deal is on, but user didn't enter original price, fallback (safety)
      if (isDeal && !productData.deal_price) {
          alert("Please enter the Original Price (strikethrough amount) for the deal.");
          return;
      }

      let error;
      
      if (state.editingProduct) {
          // UPDATE
          const res = await supabase.from('products').update(productData).eq('id', state.editingProduct.id);
          error = res.error;
      } else {
          // INSERT
          const res = await supabase.from('products').insert([productData]);
          error = res.error;
      }

      if (error) {
        alert('Error saving product: ' + error.message);
        console.error(error);
      } else {
        alert(state.editingProduct ? 'Product Updated!' : 'Product Added!');
        e.target.reset();
        state.editingProduct = null; // Exit edit mode
        await fetchAdminProducts();
        await fetchInitialProducts(); // Refresh home page data
        render();
      }
    }

    // --- AUTH LOGIC ---
    async function handleAuth(e) {
      e.preventDefault();
      const email = e.target.email.value;
      const password = e.target.password.value;
      
      const { data, error } = state.authMode === 'login' 
        ? await supabase.auth.signInWithPassword({ email, password })
        : await supabase.auth.signUp({ email, password });
        
      if (error) alert(error.message);
      else {
        if (state.authMode === 'signup') alert('Check your email for confirmation link!');
        else navigate('home');
      }
    }
    
    async function handleGoogleLogin() {
      await supabase.auth.signInWithOAuth({ provider: 'google' });
    }

    async function handleLogout() {
      await supabase.auth.signOut();
      state.user = null;
      state.isAdmin = false;
      state.cart = [];
      navigate('home');
    }

    // --- INIT ---
    // Expose functions to window so HTML on-attributes can see them
    window.navigate = navigate;
    window.toggleMenu = toggleMenu;
    window.addToCart = addToCart;
    window.removeFromCart = removeFromCart;
    window.updateQuantity = updateQuantity;
    window.handleAuth = handleAuth;
    window.handleGoogleLogin = handleGoogleLogin;
    window.handleLogout = handleLogout;
    window.setAuthMode = (mode) => { state.authMode = mode; render(); };
    
    // Admin Exports
    window.handleSaveProduct = handleSaveProduct;
    window.handleEditProduct = handleEditProduct;
    window.handleDeleteProduct = handleDeleteProduct;
    window.cancelEdit = cancelEdit;
    window.filterAdminProducts = filterAdminProducts;

    async function fetchInitialProducts() {
        const { data, error } = await supabase.from('products').select('*').eq('is_active', true);
        if (data) state.products = data;
        if (error) console.error("Initial products fetch error:", error);
    }

    async function init() {
      try {
        const categoriesRes = await supabase.from('categories').select('*').order('display_order');
        state.categories = categoriesRes.data || [];
        await fetchInitialProducts();
      } catch (e) { console.error(e); } 
      finally { render(); }

      supabase.auth.onAuthStateChange(async (event, session) => {
        const previousUser = state.user;
        state.user = session?.user || null;
        
        state.isAdmin = state.user && state.user.email === ADMIN_EMAIL;
        
        if (!previousUser && state.user) await mergeCart();
        if (state.user) await fetchCart();
        
        if (state.isAdmin && state.currentPage === 'admin') {
            await fetchAdminProducts();
        }

        render();
      });
    }
    
    init();
  </script>
</body>
</html>
